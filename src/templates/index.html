<!DOCTYPE html>
<html>
<head>
    <title>World News Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .filters { margin-bottom: 20px; display: flex; gap: 30px; align-items: center; }
        /* 2. Style for our map container */
        #map { height: 80vh; width: 100%; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>World News Map</h1>

    <div id="filter-form" class="filters">
        <div>
            <label for="date">Filter by Date:</label>
            <select name="date" id="date">
                <option value="">-- Show All --</option>
                {% for date in all_dates %}
                    <option value="{{ date }}">{{ date }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="source">Filter by Source:</label>
            <select name="source" id="source">
                <option value="">-- Show All --</option>
                <option value="https://edition.cnn.com">CNN</option>
                <option value="https://apnews.com">AP News</option>
                <option value="https://www.nbcnews.com">NBC</option>
            </select>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- Initialize Map ---
        const map = L.map('map').setView([50.0, 10.0], 5); // Centered on Europe
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);

        // --- Layer to hold all our markers ---
        // This makes it easy to clear them all at once
        let markerLayer = L.layerGroup().addTo(map);

        // --- Get Filter Elements ---
        const dateFilter = document.getElementById('date');
        const sourceFilter = document.getElementById('source');

        // --- Function to Fetch Data and Draw Markers ---
        async function updateMap() {
            const selectedDate = dateFilter.value;
            const selectedSource = sourceFilter.value;

            // Construct the API URL with query parameters
            const apiUrl = `/api/articles?date=${selectedDate}&source=${selectedSource}`;
            
            console.log(`Fetching data from: ${apiUrl}`);

            try {
                const response = await fetch(apiUrl);
                const articles = await response.json();

                // Clear existing markers before drawing new ones
                markerLayer.clearLayers();

                // Loop through articles and add markers
                articles.forEach(article => {
                    if (article.coords && article.coords.length === 2) {
                        // Create the HTML for the popup
                        const popupHtml = `
                            <div style="width: 250px; font-family: 'Inter', sans-serif;">
                                <h4 style="margin-top:0; margin-bottom:8px;">${article.title}</h4>
                                <strong>Location:</strong> ${article.info.location}<br>
                                <strong>Date:</strong> ${article.info.date}<br>
                                <a href="${article.info.url}" target="_blank" rel="noopener noreferrer">Read article</a>
                                <details style="margin-top: 8px;">
                                    <summary style="font-weight: bold; cursor: pointer;">Show Summary</summary>
                                    <p style="font-size: 0.9em;">${article.info.summary}</p>
                                </details>
                            </div>
                        `;

                        L.marker(article.coords)
                            .addTo(markerLayer)
                            .bindPopup(popupHtml);
                    }
                });
                console.log(`Added ${articles.length} markers to the map.`);
            } catch (error) {
                console.error('Failed to fetch or render map data:', error);
            }
        }

        // --- Event Listeners for Filters ---
        dateFilter.addEventListener('change', updateMap);
        sourceFilter.addEventListener('change', updateMap);

        // --- Initial Map Load ---
        // Call the function once on page load to populate the map initially
        document.addEventListener('DOMContentLoaded', updateMap);
    </script>

</body>
</html>